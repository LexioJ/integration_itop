/*! third party licenses: js/vendor.LICENSE.txt */
(function(){const f=window.t||function(d,p){return p};document.addEventListener("DOMContentLoaded",function(){const d=document.getElementById("itop-save"),p=document.getElementById("itop-personal-token"),_=document.getElementById("itop-notification-enabled"),l=document.getElementById("itop-result");if(!d||!p||!l)return;const v=document.getElementById("itop-personal-connection-status");v&&v.classList.contains("success")&&C();function C(){k(),h()}function k(){const t=document.getElementById("itop-personal-user-value"),a=document.getElementById("itop-personal-user-info");!t||!a||fetch(OC.generateUrl("/apps/integration_itop/user-info"),{method:"GET",headers:{requesttoken:OC.requestToken}}).then(e=>e.json()).then(e=>{if(e.error)t.textContent="Error: "+e.error;else{const n=e.name||"Unknown User",o=e.email||"",c=e.organization||"";t.innerHTML='\n                        <div class="itop-status-user-info-simple">\n                            <div class="itop-status-user-name">'.concat(n,"</div>\n                            ").concat(o?'<div class="itop-status-user-email">'.concat(o,"</div>"):"","\n                            ").concat(c?'<div class="itop-status-user-org">'.concat(c,"</div>"):"","\n                        </div>\n                    "),a.className="itop-personal-status-card connected"}}).catch(()=>{t.textContent="Error loading"})}function T(t){const a=document.getElementById("itop-personal-connection-status"),e=document.getElementById("itop-personal-connection-value");a&&e&&(a.className="itop-personal-status-card itop-connection-status success",e.textContent="Configured");const n=document.getElementById("itop-personal-user-info"),o=document.getElementById("itop-personal-user-value");if(n&&o&&t){n.className="itop-personal-status-card connected";const c=t.name||"Unknown User",r=t.email||"",i=t.organization||"";o.innerHTML='\n                    <div class="itop-status-user-info-simple">\n                        <div class="itop-status-user-name">'.concat(c,"</div>\n                        ").concat(r?'<div class="itop-status-user-email">'.concat(r,"</div>"):"","\n                        ").concat(i?'<div class="itop-status-user-org">'.concat(i,"</div>"):"","\n                    </div>\n                ")}h()}function h(){const t=document.getElementById("itop-personal-tickets-value"),a=document.getElementById("itop-personal-tickets-info");!t||!a||(t.textContent="Loading...",fetch(OC.generateUrl("/apps/integration_itop/tickets/count"),{method:"GET",headers:{requesttoken:OC.requestToken}}).then(e=>e.json()).then(e=>{if(e.error)t.textContent="Error: "+e.error;else if(typeof e.incidents<"u"&&typeof e.requests<"u"){const n=e.incidents||0,o=e.requests||0,c=n+o;t.innerHTML='\n                        <div class="itop-ticket-counts">\n                            <div>'.concat(f("integration_itop","Incident(s):"),' <span class="itop-count-large">').concat(n,"</span></div>\n                            <div>").concat(f("integration_itop","Request(s):"),' <span class="itop-count-large">').concat(o,"</span></div>\n                        </div>\n                    "),c>0?a.className="itop-personal-status-card has-tickets connected":a.className="itop-personal-status-card connected"}else t.innerHTML='\n                        <div class="itop-ticket-counts">\n                            <div>'.concat(f("integration_itop","Incident(s):"),' <span class="itop-count-large">0</span></div>\n                            <div>').concat(f("integration_itop","Request(s):"),' <span class="itop-count-large">0</span></div>\n                        </div>\n                    ')}).catch(()=>{t.textContent="Error loading"}))}function m(t,a=!1,e=null){if(e&&T(e),a){l.innerHTML="",l.className="error";const n=document.createElement("div");n.className="result-main";const o=document.createElement("span");o.className="icon icon-error";const c=document.createElement("span");c.className="message",c.textContent=t,n.appendChild(o),n.appendChild(c);const r=document.createElement("button");r.className="close-button",r.innerHTML="×",r.title="Close",r.addEventListener("click",()=>{l.classList.add("hidden")}),n.appendChild(r),l.appendChild(n),l.classList.remove("hidden")}else OC.Notification&&OC.Notification.showTemporary&&OC.Notification.showTemporary(t+" ✅"),p.value="",l.classList.add("hidden")}d.addEventListener("click",function(){l.classList.add("hidden");const t=p.value.trim(),a=_.checked?"1":"0";d.disabled=!0;const e=d.innerHTML;d.innerHTML='<span class="icon">⏳</span> Saving...';const n={notification_enabled:a};t&&t.trim()!==""&&(n.personal_token=t);const o=document.querySelectorAll('input[name="user_ci_class"]');if(o.length>0){const s=[];o.forEach(function(u){u.checked||s.push(u.value)}),n.disabled_ci_classes=s}const c=document.querySelectorAll("input[data-notification-type]");if(c.length>0){const s=[],u=[];c.forEach(function(g){if(!g.checked){const E=g.dataset.notificationType,y=g.dataset.notification;E==="portal"?s.push(y):E==="agent"&&u.push(y)}}),s.length>0?n.disabled_portal_notifications=s:n.disabled_portal_notifications=[],u.length>0?n.disabled_agent_notifications=u:n.disabled_agent_notifications=[]}const r=document.getElementById("notification-check-interval");if(r){const s=parseInt(r.value);s>=5&&s<=1440&&(n.notification_check_interval=s)}const i=new XMLHttpRequest;i.open("PUT",OC.generateUrl("/apps/integration_itop/config")),i.setRequestHeader("requesttoken",OC.requestToken),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){if(i.readyState===4)if(d.disabled=!1,d.innerHTML=e,i.status===200)try{const s=JSON.parse(i.responseText);s.person_id_configured&&s.user_info?m(s.message||"Configuration successful!",!1,s.user_info):m(s.message||"Settings saved",!1)}catch(s){m("Failed to parse server response",!0)}else try{const s=i.responseText?JSON.parse(i.responseText):{},u=s.error||s.message||"Failed to save settings";m(u,!0)}catch(s){m("Server error (status: "+i.status+")",!0)}},i.send(JSON.stringify(n))})})})();
//# sourceMappingURL=integration_itop-personal-settings.mjs.map
