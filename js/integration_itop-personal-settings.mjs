/*! third party licenses: js/vendor.LICENSE.txt */
(function(){const m=window.t||function(r,u){return u};document.addEventListener("DOMContentLoaded",function(){const r=document.getElementById("itop-save"),u=document.getElementById("itop-personal-token"),f=document.getElementById("itop-notification-enabled"),d=document.getElementById("itop-result");if(!r||!u||!d)return;f&&f.addEventListener("change",function(){const e=document.getElementById("notification-settings-content");e&&(f.checked?e.style.display="":e.style.display="none")});const h=document.getElementById("itop-personal-connection-status");h&&h.classList.contains("success")&&C();function C(){k(),y()}function k(){const e=document.getElementById("itop-personal-user-value"),i=document.getElementById("itop-personal-user-info");!e||!i||fetch(OC.generateUrl("/apps/integration_itop/user-info"),{method:"GET",headers:{requesttoken:OC.requestToken}}).then(t=>t.json()).then(t=>{if(t.error)e.textContent="Error: "+t.error;else{const n=t.name||"Unknown User",a=t.email||"",c=t.organization||"";e.innerHTML='\n                        <div class="itop-status-user-info-simple">\n                            <div class="itop-status-user-name">'.concat(n,"</div>\n                            ").concat(a?'<div class="itop-status-user-email">'.concat(a,"</div>"):"","\n                            ").concat(c?'<div class="itop-status-user-org">'.concat(c,"</div>"):"","\n                        </div>\n                    "),i.className="itop-personal-status-card connected"}}).catch(()=>{e.textContent="Error loading"})}function T(e){const i=document.getElementById("itop-personal-connection-status"),t=document.getElementById("itop-personal-connection-value");i&&t&&(i.className="itop-personal-status-card itop-connection-status success",t.textContent="Configured");const n=document.getElementById("itop-personal-user-info"),a=document.getElementById("itop-personal-user-value");if(n&&a&&e){n.className="itop-personal-status-card connected";const c=e.name||"Unknown User",o=e.email||"",s=e.organization||"";a.innerHTML='\n                    <div class="itop-status-user-info-simple">\n                        <div class="itop-status-user-name">'.concat(c,"</div>\n                        ").concat(o?'<div class="itop-status-user-email">'.concat(o,"</div>"):"","\n                        ").concat(s?'<div class="itop-status-user-org">'.concat(s,"</div>"):"","\n                    </div>\n                ")}y()}function y(){const e=document.getElementById("itop-personal-tickets-value"),i=document.getElementById("itop-personal-tickets-info");!e||!i||(e.textContent="Loading...",fetch(OC.generateUrl("/apps/integration_itop/tickets/count"),{method:"GET",headers:{requesttoken:OC.requestToken}}).then(t=>t.json()).then(t=>{if(t.error)e.textContent="Error: "+t.error;else if(typeof t.incidents<"u"&&typeof t.requests<"u"){const n=t.incidents||0,a=t.requests||0,c=n+a;e.innerHTML='\n                        <div class="itop-ticket-counts">\n                            <div>'.concat(m("integration_itop","Incident(s):"),' <span class="itop-count-large">').concat(n,"</span></div>\n                            <div>").concat(m("integration_itop","Request(s):"),' <span class="itop-count-large">').concat(a,"</span></div>\n                        </div>\n                    "),c>0?i.className="itop-personal-status-card has-tickets connected":i.className="itop-personal-status-card connected"}else e.innerHTML='\n                        <div class="itop-ticket-counts">\n                            <div>'.concat(m("integration_itop","Incident(s):"),' <span class="itop-count-large">0</span></div>\n                            <div>').concat(m("integration_itop","Request(s):"),' <span class="itop-count-large">0</span></div>\n                        </div>\n                    ')}).catch(()=>{e.textContent="Error loading"}))}function p(e,i=!1,t=null){if(t&&T(t),i){d.innerHTML="",d.className="error";const n=document.createElement("div");n.className="result-main";const a=document.createElement("span");a.className="icon icon-error";const c=document.createElement("span");c.className="message",c.textContent=e,n.appendChild(a),n.appendChild(c);const o=document.createElement("button");o.className="close-button",o.innerHTML="×",o.title="Close",o.addEventListener("click",()=>{d.classList.add("hidden")}),n.appendChild(o),d.appendChild(n),d.classList.remove("hidden")}else OC.Notification&&OC.Notification.showTemporary&&OC.Notification.showTemporary(e+" ✅"),u.value="",d.classList.add("hidden")}r.addEventListener("click",function(){d.classList.add("hidden");const e=u.value.trim(),i=f.checked?"1":"0";r.disabled=!0;const t=r.innerHTML;r.innerHTML='<span class="icon">⏳</span> Saving...';const n={notification_enabled:i};e&&e.trim()!==""&&(n.personal_token=e);const a=document.querySelectorAll('input[name="user_ci_class"]');if(a.length>0){const s=[];a.forEach(function(l){l.checked||s.push(l.value)}),n.disabled_ci_classes=s}if(i==="0")n.disabled_portal_notifications="all",n.disabled_agent_notifications="all";else{const s=document.querySelectorAll("input[data-notification-type]");if(s.length>0){const l=[],g=[];s.forEach(function(v){if(!v.checked){const _=v.dataset.notificationType,E=v.dataset.notification;_==="portal"?l.push(E):_==="agent"&&g.push(E)}}),l.length>0?n.disabled_portal_notifications=l:n.disabled_portal_notifications=[],g.length>0?n.disabled_agent_notifications=g:n.disabled_agent_notifications=[]}}const c=document.getElementById("notification-check-interval");if(c){const s=parseInt(c.value);s>=5&&s<=1440&&(n.notification_check_interval=s)}const o=new XMLHttpRequest;o.open("PUT",OC.generateUrl("/apps/integration_itop/config")),o.setRequestHeader("requesttoken",OC.requestToken),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){if(o.readyState===4)if(r.disabled=!1,r.innerHTML=t,o.status===200)try{const s=JSON.parse(o.responseText);s.person_id_configured&&s.user_info?p(s.message||"Configuration successful!",!1,s.user_info):p(s.message||"Settings saved",!1)}catch(s){p("Failed to parse server response",!0)}else try{const s=o.responseText?JSON.parse(o.responseText):{},l=s.error||s.message||"Failed to save settings";p(l,!0)}catch(s){p("Server error (status: "+o.status+")",!0)}},o.send(JSON.stringify(n))})})})();
//# sourceMappingURL=integration_itop-personal-settings.mjs.map
